<!DOCTYPE html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMeQaETGjkZNtCwEMhdb_Mhs8mI-v05rw&sensor=true"></script>

    <script>
        var lat = localStorage["lat"] || 41.0;
        var lng = localStorage["lng"] || -73.0;
        var myLatlng = new google.maps.LatLng(lat, lng);
        var opts = {enableHighAccuracy: true, maximumAge: 5000}
        var markerBounds = new google.maps.LatLngBounds();
        var map;
        var name = prompt("Who are you?", "nobody");
        var markers = [];

        function get_location(){
          navigator.geolocation.watchPosition(show_map, handle_error, opts);
        }

        function show_map(position){

          lat = position.coords.latitude;
          lng = position.coords.longitude;
          localStorage["lat"] = lat;
          localStorage["lng"] = lng;
          newLatLng = new google.maps.LatLng(lat, lng);

          if(window.websocket === undefined){
            openWebsocket();
          }

          if (window.websocket.readyState == 1){
            sendData();
          }else if(window.websocket.readyState === 3){
            window.websocket.close();
            openWebsocket();
            console.log("websocket not open");
          }

          console.log(lat);
          console.log(lng);
        }

        function sendData(){
          websocket.send("name " + name + " lat " + lat + " lng " + lng);
        }

        function find_index_of_name_in_markers(name){
          for(var i = 0; i < markers.length; i++){
            if(markers[i].title === name) return i;
          }
          return -1;
        }


        function openWebsocket(){
            var url = document.URL
            window.websocket = new WebSocket(url.replace("http", "ws") + "ws");
            window.websocket.onmessage = function(message){
              try {
                  var json = JSON.parse(message.data);
                  var name = json.name;
                  var idx = find_index_of_name_in_markers(name);
                  var pos = new google.maps.LatLng(json.lat, json.lng);
                  if(idx === -1){
                    // couldn't find existing marker, make a new one
                    var mark = new google.maps.Marker({position: pos , map: map, title: json.name})
                    markers.push(mark);
                  }else{
                    markers[idx].setPosition(pos);
                  }
                  if(markerBounds.contains(pos)){
                    // do nothing
                  }else{
                    markerBounds.extend(pos);
                    map.fitBounds(markerBounds);
                  }

              } catch (e) {
                  console.log("This doesn't look like a valid JSON: ", message);
                  return;
              }
            }
        }
        function handle_error(err){
          if (err.code == 1){
          // user said no
          }
        }

      function initialize() {
        mapOptions = {
          center: myLatlng,
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      }

      google.maps.event.addDomListener(window, 'load', initialize);
      get_location();
    </script>

  </head>
  <body>
    <div id='message'>
    </div>
    <div id="map-canvas" style="width: 100%; height: 100%"></div>

    <script>
      $(function(){

      });
    </script>
  </body>


</html>
