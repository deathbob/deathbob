<!DOCTYPE html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMeQaETGjkZNtCwEMhdb_Mhs8mI-v05rw&sensor=true"></script>

    <script>
        var lat = localStorage["lat"] || 41.0;
        var lng = localStorage["lng"] || -73.0;
        var myLatlng = new google.maps.LatLng(lat, lng);
        var opts = {enableHighAccuracy: true, maximumAge: 5000}

        function get_location(){
          navigator.geolocation.watchPosition(show_map, handle_error, opts);
        }
        function show_map(position){

          lat = position.coords.latitude;
          lng = position.coords.longitude;
          localStorage["lat"] = lat;
          localStorage["lng"] = lng;
          newLatLng = new google.maps.LatLng(lat, lng);
          if (marker != undefined){
            marker.setPosition(newLatLng);
          }else{
            marker = new google.maps.Marker({
              position: newLatLng,
              map: map,
              title:"You"
            });
          };
          map.panTo(newLatLng);

          if(window.websocket === undefined){
            window.websocket = new WebSocket("ws://localhost:8080/ws")
            window.websocket.onmessage = function(message){
              try {
                  var json = JSON.parse(message.data);
              } catch (e) {
                  console.log('This doesn\'t look like a valid JSON: ', message);
                  return;
              }
            }
          }

        if (window.websocket.readyState == 1){
          window.websocket.send({lat: lat, lng: lng});
        }else{
        console.log("websocket not open");
        }


          console.log(lat);
          console.log(lng);
        }
        function handle_error(err){
          if (err.code == 1){
          // user said no
          }

        }

      get_location();

      var map;

      function initialize() {
        mapOptions = {
          center: myLatlng,
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        marker = new google.maps.Marker({
          position: myLatlng,
          map: map,
          title:"You"
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>

  </head>
  <body>
    <div id='message'>
    </div>
    <div id="map-canvas" style="width: 100%; height: 100%"></div>

    <script>
      $(function(){

      });
    </script>
  </body>


</html>
