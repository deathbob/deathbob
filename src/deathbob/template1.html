<!DOCTYPE html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMeQaETGjkZNtCwEMhdb_Mhs8mI-v05rw&sensor=true"></script>

    <script>
        var lat = localStorage["lat"] || 41.0;
        var lng = localStorage["lng"] || -73.0;
        var myLatlng = new google.maps.LatLng(lat, lng);
        var opts = {enableHighAccuracy: true, maximumAge: 2500}
        var map;
        var name = prompt("Who are you?", "nobody");
        var markers = [];

        function get_location(){
          watch = navigator.geolocation.watchPosition(show_map, handle_error, opts);
        }

        function submitAnyway(){
          navigator.geolocation.getCurrentPosition(show_map, handle_error, opts);
        }

        function handle_error(err){
          console.log(err);
          if (err.code == 1){
          // user said no
          }else{
            console.log(err);
          }
        }

        function show_map(position){
          lat = position.coords.latitude;
          lng = position.coords.longitude;
          localStorage["lat"] = lat;
          localStorage["lng"] = lng;
          newLatLng = new google.maps.LatLng(lat, lng);
          console.log("inside show_map");

          mark_position_for_name(newLatLng, name);

          if (window.websocket.readyState == 1){
            console.log("sending data");
            sendData();
          }else{
            watchWebsocket();
          }
        }

        function sendData(){
          console.log("sending data");
          websocket.send("name " + name + " lat " + lat + " lng " + lng);
        }

        function mark_position_for_name(position, name){
          console.log("Inside mark_position_for_name")
          var idx = find_index_of_name_in_markers(name);
          if(idx === -1){
            // couldn't find existing marker, make a new one
            var mark = new google.maps.Marker({position: position , map: map, title: name})
            markers.push(mark);
          }else{
            markers[idx].setPosition(position);
          }
          mapBounds = map.getBounds();

          if(mapBounds.contains(position)){
            // do nothing
          }else{
            mapBounds.extend(position);
            map.fitBounds(mapBounds);
          }
        }

        function find_index_of_name_in_markers(name){
          for(var i = 0; i < markers.length; i++){
            if(markers[i].title === name) return i;
          }
          return -1;
        }

        function watchWebsocket(){
          if(window.websocket === undefined){
            openWebsocket();
          }else if(window.websocket.readyState === 3){
            console.log("websocket already closed");
            openWebsocket();
          }else{
            console.log(websocket.readyState);
          }
        }

        function openWebsocket(){
            window.websocket = new WebSocket("ws://" + location.host + "/ws");
            window.websocket.onmessage = function(message){
              try {
                  var json = JSON.parse(message.data);
                  console.log("Got data!");
                  console.log(json);
                  var name = json.name;
                  var pos = new google.maps.LatLng(json.lat, json.lng);
                  mark_position_for_name(pos, name);

              } catch (e) {
                  console.log("This doesn't look like a valid JSON: ", message);
                  return;
              }
            }
        }

      function initialize() {
        mapOptions = {
          center: myLatlng,
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        openWebsocket();
        get_location();
        intervalTimer = setInterval(submitAnyway, 5000);
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>

  </head>
  <body>
    <div id='message'>
    </div>
    <div id="map-canvas" style="width: 100%; height: 100%"></div>

    <script>
      $(function(){

      });
    </script>
  </body>


</html>
